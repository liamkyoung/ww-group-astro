---
import { getPostBySlug } from "../../lib/queries/posts";
import BlogPost from "../../layouts/BlogPost.astro";
import { portableTextToHtml } from "../../lib/portableText";
import { urlFor } from "../../lib/sanityImage";

export async function getStaticPaths() {
  // Reuse getAllPosts to pre-generate all pages
  const { getAllPosts } = await import("../../lib/queries/posts");
  const posts = await getAllPosts();

  return posts.map((post) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug as string);

if (!post) {
  throw new Error(`Post not found for slug: ${slug}`);
}

const html = portableTextToHtml(post.body);
---

<BlogPost
  title={post.title}
  pubDate={new Date(post.publishedAt)}
  description={post.description}
  imgSrc={urlFor(post.mainImage).url()}
>
  <div set:html={html} />
</BlogPost>

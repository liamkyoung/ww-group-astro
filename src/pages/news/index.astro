---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import { getAllPosts } from "../../lib/queries/posts";
import { urlFor } from "../../lib/sanityImage";
import Default from "@/layouts/Default.astro";
import CTA from "@/components/CTA.astro";

const posts = await getAllPosts();

if (!posts) {
  throw new Error(`No posts found: ${posts}`);
}

// Assume featured[0] is the main hero, [1] and [2] are side features
const mainFeature = posts[0];
const sideFeatures = posts.slice(1, 3);
const latest = posts.slice(3);

const getSlug = (slug: string) => `/news/${slug}`;
---

<Default>
  <section class="blog-page">
    <!-- HERO SECTION -->
    <div class="hero-grid">
      {
        mainFeature && (
          <article class="hero-main">
            <a href={getSlug(mainFeature.slug.current)} class="hero-main__link">
              {mainFeature && mainFeature.mainImage && (
                <img
                  src={urlFor(mainFeature.mainImage).url()}
                  alt={mainFeature.title}
                />
              )}

              <div class="hero-main__overlay">
                <h2 class="text-white">{mainFeature.title}</h2>
              </div>

              <button class="hero-nav hero-nav--left" aria-label="Previous">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 19.5 8.25 12l7.5-7.5"
                  />
                </svg>
              </button>
              <button class="hero-nav hero-nav--right" aria-label="Next">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m8.25 4.5 7.5 7.5-7.5 7.5"
                  />
                </svg>
              </button>

              <div class="hero-dots" aria-hidden="true">
                <span class="dot dot--active" />
                <span class="dot" />
                <span class="dot" />
              </div>
            </a>
          </article>
        )
      }

      <div class="hero-side">
        {
          sideFeatures.map((post) => (
            <article class="hero-side__item">
              <a href={getSlug(post.slug.current)} class="hero-side__link">
                <img src={urlFor(post.mainImage).url()} alt={post.title} />
                <div class="hero-side__overlay">
                  <h3 class="text-white">{post.title}</h3>
                </div>
              </a>
            </article>
          ))
        }
      </div>
    </div>

    <!-- LATEST SECTION -->
    <section class="latest">
      <header class="latest__header">
        <h2>Latest</h2>
      </header>

      <div class="latest-grid">
        {
          latest &&
            latest.map((post) => (
              <article class="card">
                <a href={getSlug(post.slug.current)} class="card__link">
                  <div class="card__image-wrapper">
                    <img src={urlFor(post.mainImage).url()} alt={post.title} />
                  </div>
                  <div class="card__content">
                    <h3>{post.title}</h3>
                    {post.excerpt && <p>{post.excerpt}</p>}
                  </div>
                </a>
              </article>
            ))
        }
      </div>
    </section>
  </section>

  <style>
    .blog-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    /* HERO GRID */

    .hero-grid {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 1rem;
      margin-bottom: 3rem;
    }

    .hero-main,
    .hero-side__item {
      position: relative;
      border-radius: 0.75rem;
      overflow: hidden;
      background: #000;
    }

    .hero-main__link,
    .hero-side__link {
      display: block;
      position: relative;
      height: 100%;
      color: inherit;
      text-decoration: none;
    }

    .hero-main img,
    .hero-side__item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 200ms ease-out;
    }

    .hero-main__link:hover img,
    .hero-side__link:hover img {
      transform: scale(1.03);
    }

    .hero-main__overlay,
    .hero-side__overlay {
      position: absolute;
      inset: auto 0 0 0;
      padding: 1.25rem 1.5rem;
      color: #fff;
      background: linear-gradient(
        to top,
        rgba(0, 0, 0, 0.7),
        rgba(0, 0, 0, 0.7)
      );
    }

    .hero-main__overlay h2 {
      font-size: 1.6rem;
      line-height: 1.3;
      margin: 0.5rem 0 0;
    }

    .hero-side__overlay h3 {
      font-size: 1rem;
      line-height: 1.35;
      margin: 0.4rem 0 0;
    }

    .hero-side {
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 0.75rem;
    }

    /* Slider controls (just visual for now) */

    .hero-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
    }

    .hero-nav--left {
      left: 0.75rem;
    }

    .hero-nav--right {
      right: 0.75rem;
    }

    .hero-dots {
      position: absolute;
      right: 1.25rem;
      top: 1.25rem;
      display: flex;
      gap: 0.3rem;
    }

    .dot {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.55);
    }

    .dot--active {
      width: 0.7rem;
      background: #fff;
    }

    /* Pills / Tags */

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(255, 255, 255, 0.9);
      color: #222;
    }

    .pill--small {
      font-size: 0.7rem;
      padding: 0.14rem 0.5rem;
    }

    /* LATEST SECTION */

    .latest {
      margin-top: 1rem;
    }

    .latest__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .latest__header h2 {
      font-size: 1.4rem;
    }

    .latest__view-more {
      font-size: 0.9rem;
      text-decoration: none;
      color: #b4311a;
      font-weight: 600;
    }

    .latest-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 1rem;
    }

    .card {
      border-radius: 0.75rem;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .card__link {
      display: flex;
      flex-direction: column;
      height: 100%;
      text-decoration: none;
      color: inherit;
    }

    .card__image-wrapper {
      aspect-ratio: 4 / 3;
      overflow: hidden;
    }

    .card__image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 200ms ease-out;
    }

    .card__link:hover .card__image-wrapper img {
      transform: scale(1.03);
    }

    .card__content {
      padding: 0.75rem 0.9rem 1rem;
    }

    .card__content h3 {
      font-size: 0.95rem;
      line-height: 1.35;
      margin: 0.4rem 0 0.35rem;
    }

    .card__content p {
      font-size: 0.85rem;
      line-height: 1.4;
      color: #555;
      margin: 0;
    }

    /* RESPONSIVE */

    @media (max-width: 1024px) {
      .hero-grid {
        grid-template-columns: 1.8fr 1.2fr;
      }

      .latest-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      .hero-grid {
        grid-template-columns: 1fr;
      }

      .hero-side {
        grid-template-rows: repeat(2, minmax(0, 200px));
      }

      .latest-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 540px) {
      .blog-page {
        padding-inline: 0.75rem;
      }

      .latest-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <CTA />
</Default>

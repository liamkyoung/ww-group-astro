---
import Default from "@/layouts/Default.astro";
import { getAllTeammateSlugs, getTeammateBySlug } from "@/lib/queries/teammate";
import { portableTextToHtml } from "@/lib/portableText";
import TeammateHero from "@/components/Hero/TeammateHero.astro";
import ContactAndBio from "@/components/ContactAndBio.astro";
import { getProjectsByTeammateSlug } from "@/lib/queries/projects";
import ProjectGallery from "@/components/Gallery/ProjectGallery.astro";
import CommunityResourceGallery from "@/components/Gallery/CommunityResourceGallery.astro";
import { getCommunityResourcesByTeammateSlug } from "@/lib/queries/communityResources";
import { getListingPreviewsByAgentSlug } from "@/lib/queries/listings";
import { ListingGallery } from "@/components/Gallery/ListingGallery";

export const prerender = false;

// Build all static paths at build-time
export async function getStaticPaths() {
  const slugs = await getAllTeammateSlugs();

  return slugs.map((slug) => ({
    params: { slug },
    props: { slug }, // optional but handy
  }));
}

const { slug } = Astro.params;
const teammate = await getTeammateBySlug(slug as string);

if (!teammate) {
  // You can also render a custom 404 layout instead of throwing
  throw new Error(`Teammate not found for slug: ${slug}`);
}

// Destructure what you'll likely use
const {
  title,
  jobTitle,
  profilePic,
  profileIntroduction,
  bioParagraph,
  strengths,
  yearsOfExperience,
  phoneNumber,
  officeNumber,
  email,
  instagram,
  facebook,
  linkedin,
} = teammate;

// TODO: when you wire image URLs, use your urlFor() helper or sanity-image-url here.

const bioHtml = portableTextToHtml(bioParagraph);
const projects = await getProjectsByTeammateSlug(slug);
const commResources = await getCommunityResourcesByTeammateSlug(slug);
const listings = await getListingPreviewsByAgentSlug(slug);
---

<Default>
  <section class="global-margin-x my-24 space-y-12">
    <TeammateHero
      name={title}
      jobTitle={jobTitle}
      shortDescription={profileIntroduction}
      yearsOfExperience={yearsOfExperience}
      strength={strengths}
      fullBodyImage={profilePic}
    />
    <ContactAndBio
      email={email}
      phoneNumber={phoneNumber}
      officeNumber={officeNumber}
      linkedin={linkedin}
      instagram={instagram}
      facebook={facebook}
      bioHtml={bioHtml}
    />
  </section>

  <ListingGallery listings={listings} />
  {projects && <ProjectGallery projects={projects} />}

  <section>
    <div class="global-margin-x mb-10">
      <h2>My Favorite Places in Tampa Bay</h2>
    </div>

    <CommunityResourceGallery
      displayHeader="yes"
      communityResources={commResources}
    />
  </section>
</Default>
